##
# Harris vue Config
##
## 用户的 IP 地址 $binary_remote_addr 作为 Key，每个 IP 地址每秒处理 5 个请求
## 你想用程序每秒几百次的刷我，没戏，再快了就不处理了，直接返回 503 错误给你
## limit_req zone=req_limit_per_ip burst=9 nodelay; 最多 9 个排队， 由于每秒处理 5 个请求 + 15个排队，你一秒最多发送 20 个请求过来，再多就直接返回 503 错误给你了
limit_req_zone $binary_remote_addr zone=zhiboapi_req_limit_per_ip:10m rate=5r/s;
#log_format postdata $request_body;
#    https://docs.nginx.com/nginx/admin-guide/monitoring/logging/
#    $upstream_connect_time – The time spent on establishing a connection with an upstream server
#    $upstream_header_time – The time between establishing a connection and receiving the first byte of the response header from the upstream server
#    $upstream_response_time – The time between establishing a connection and receiving the last byte of the response body from the upstream server
#    $request_time – The total time spent processing a request

log_format zhiboapiformat '$remote_addr - $remote_user [$time_local] '
                             '"$request" $status $body_bytes_sent '
                             '"$http_referer" "$http_user_agent" "$gzip_ratio"'
                             'rt=$request_time uct="$upstream_connect_time" uht="$upstream_header_time" urt="$upstream_response_time"'
                             'request=$request_body'
                             'sslprotocol=$ssl_protocol $ssl_cipher '
                             ;

server {

    listen 80;
    #listen [::]:80;
    server_name www.zhiboapi.me;
    root /var/www/webapi/public;


    ##
    # Nginx Bad Bot Blocker Includes
    # REPO: https://github.com/mitchellkrogza/nginx-ultimate-bad-bot-blocker
    ##
	include /etc/nginx/bots.d/ddos.conf;
 	include /etc/nginx/bots.d/blockbots.conf;

    index index.php index.html index.htm;
    add_header Access-Control-Allow-Origin $http_origin;
    add_header Access-Control-Allow-Headers $http_access_control_request_headers;
    add_header Access-Control-Allow-Methods 'GET, PUT, POST, OPTIONS, DELETE';
    add_header Access-Control-Expose-Headers 'Date';
    add_header Access-Control-Allow-Credentials true;
    if ($request_method = OPTIONS) {
        return 200;
    }

    gzip on;
    gzip_buffers 32 4k;
    gzip_comp_level 6;
    gzip_min_length 200;
    gzip_types text/css text/xml application/javascript;
    gzip_vary on;
    client_max_body_size 20m;

    location /payment/ {
        try_files $uri $uri/ /payment/index.php?$query_string;
    }

    location /payment/deduction/ {
        proxy_pass_header Server;

        proxy_set_header   Host             $host;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   X-Form "kehu_ng";

        proxy_pass http://172.16.16.166:10666/payment/deduction/;
    }

    location /payment/remittance/ {
        proxy_pass_header Server;

        proxy_set_header   Host             $host;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   X-Form "kehu_ng";

        proxy_pass http://172.16.16.166:10666/payment/remittance/;
    }

    location / {
        index index.html index.php;
        if (!-e $request_filename) {
            # rewrite ^/([0-9]+)/$ /home/show/index?roomnum=$1 permanent;

            rewrite ^/index.php(.*)$ /index.php?s=$1 last;
            rewrite ^(.*)$ /index.php?s=$1 last;
            break;
        }
    }

    location ~ \/upload\/.*\.php {
        deny all;
        return 404;
    }

     location ~ \.php$ {
            add_header      Access-Control-Allow-Origin *;
            try_files $uri /index.php =404;
            fastcgi_pass php-fpm73:9000;
            fastcgi_index index.php;
            fastcgi_buffers 16 16k;
            fastcgi_buffer_size 32k;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param HTTP_AUTHORIZATION $http_authorization;
            #fixes timeouts
            fastcgi_read_timeout 600;
            include fastcgi_params;
        }

    location ~ /\.ht {
        deny all;
    }

    location /.well-known/acme-challenge/ {
        root /var/www/letsencrypt/;
        log_not_found off;
    }
    ########################## Check Request Methods and Some Bots ##############################################################
    ## Only allow these request methods ##
    if ($request_method !~ ^(GET|HEAD|POST|PUT|OPTIONS)$ ) {
        return 503;
       #return 444;
    }
      ## Do not accept DELETE, SEARCH and other methods ##########################
      ## Block download agents
      #PostmanRuntime/7.22.0
      #Apache-HttpClient/4.5.10 (Java/11.0.5)
      #RestSharp 106.6.10.0"
      ##
    if ($http_user_agent ~* LWP::Simple|BBBike|wget|PostmanRuntime|Apache-HttpClient|RestSharp) {
          return 503;
          #return 403;
    }
     ## Block some robots ##
    if ($http_user_agent ~* msnbot|scrapbot|Catall|Spider|AcoiRobot) {
          return 503;
          #return 403;
    }
     ## Deny certain Referers ###
    if ( $http_referer ~* (babes|forsale|girl|jewelry|love|nudit|organic|poker|porn|sex|teen) )
    {
        return 503;
        #return 403;
    }
  ##############################################################################################################################
    error_log /var/log/nginx/zhibo_error.log;
    access_log /var/log/nginx/zhibo_access.log zhiboapiformat;

    error_page 503 /503.html;
    location = /503.html {
      root /usr/share/nginx/html;
      internal;
    }
}
